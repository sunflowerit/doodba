#!/usr/local/bin/python-odoo-shell
import logging
import os

# Update system varibles
with open(os.path.join(os.environ.get("ODOO_WORK_DIR"), 'odoo-variables')) as variablesource:
    for line in variablesource:
        if 'export' not in line:
            continue
        if line.startswith('#'):
            continue
        if line.startswith('export PATH'):
            continue
        # Remove `"` and `export `
        # then, split name / value pair
        key, value = line.replace('"', '', 2).replace('export ', '', 1).strip().split('=', 1)
        os.environ[key] = value

_logger = logging.getLogger("autoupdate")

# TODO Delete this script at some point
_logger.warning("`autoupdate` is DEPRECATED. Use click-odoo-update instead.")

# Note: ``module_auto_update`` must be installed in Odoo for this to work.
try:
    env["ir.module.module"].upgrade_changed_checksum
except AttributeError:
    env["base.module.upgrade"].upgrade_module()
else:
    # Disable deprecated stuff
    env["ir.config_parameter"].set_param(
        "module_auto_update.enable_deprecated",
        "0",
    )
    # Newer versions of ``module_auto_update`` recommend this approach
    env["ir.module.module"].upgrade_changed_checksum(
        os.environ.get("I18N_OVERWRITE") == "1",
    )
env.cr.commit()
